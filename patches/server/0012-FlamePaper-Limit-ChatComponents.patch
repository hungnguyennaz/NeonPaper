From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: LinsaFTW <25271111+linsaftw@users.noreply.github.com>
Date: Mon, 21 Jun 2021 03:29:33 -0300
Subject: [PATCH] (FlamePaper) Limit ChatComponents

Original code by 2lstudios-mc, licensed under MIT
You can find the original code on https://github.com/2lstudios-mc/FlamePaper

diff --git a/src/main/java/net/minecraft/server/IChatBaseComponent.java b/src/main/java/net/minecraft/server/IChatBaseComponent.java
index 22418b953533472bbf86ab686022287d6ad7bddd..1ce63c04002c4aa06721bbc86a096ce41aa88905 100644
--- a/src/main/java/net/minecraft/server/IChatBaseComponent.java
+++ b/src/main/java/net/minecraft/server/IChatBaseComponent.java
@@ -41,17 +41,31 @@ public interface IChatBaseComponent extends Iterable<IChatBaseComponent> {
 
         public ChatSerializer() {}
 
-        public IChatBaseComponent a(JsonElement jsonelement, Type type, JsonDeserializationContext jsondeserializationcontext) throws JsonParseException {
+        public IChatBaseComponent a(int extraCount, String lastElement, JsonElement jsonelement, Type type, JsonDeserializationContext jsondeserializationcontext) throws JsonParseException {
             if (jsonelement.isJsonPrimitive()) {
                 return new ChatComponentText(jsonelement.getAsString());
             } else if (!jsonelement.isJsonObject()) {
                 if (jsonelement.isJsonArray()) {
                     JsonArray jsonarray = jsonelement.getAsJsonArray();
+
+                    // FlamePaper start - Limit ChatComponents
+                    if (jsonarray.size() > 12) {
+                        throw new JsonParseException("Too many ChatComponent array elements");
+                    }
+                    // FlamePaper end - Limit Chatcomponents
+
                     IChatBaseComponent ichatbasecomponent = null;
                     Iterator iterator = jsonarray.iterator();
 
                     while (iterator.hasNext()) {
                         JsonElement jsonelement1 = (JsonElement) iterator.next();
+
+                        // FlamePaper start - Limit ChatComponents
+                        if (jsonelement1.isJsonArray()) {
+                            throw new JsonParseException("Stacked ChatComponent array");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
                         IChatBaseComponent ichatbasecomponent1 = this.a(jsonelement1, (Type) jsonelement1.getClass(), jsondeserializationcontext);
 
                         if (ichatbasecomponent == null) {
@@ -76,10 +90,29 @@ public interface IChatBaseComponent extends Iterable<IChatBaseComponent> {
 
                     if (jsonobject.has("with")) {
                         JsonArray jsonarray1 = jsonobject.getAsJsonArray("with");
+
+                        // FlamePaper start - Limit ChatComponents
+                        if (jsonarray1.size() > 12) {
+                            throw new JsonParseException("Too many ChatComponent array elements in with");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
+                        // FlamePaper start - Limit ChatComponents
+                        if (lastElement != null && lastElement.equals("with")) {
+                            throw new JsonParseException("Stacked with ChatComponent elements");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
                         Object[] aobject = new Object[jsonarray1.size()];
 
                         for (int i = 0; i < aobject.length; ++i) {
-                            aobject[i] = this.a(jsonarray1.get(i), type, jsondeserializationcontext);
+                            // FlamePaper start - Limit ChatComponents
+                            if (jsonarray1.get(i).isJsonArray()) {
+                                throw new JsonParseException("Stacked ChatComponent array in with element");
+                            }
+                            // FlamePaper end - Limit Chatcomponents
+
+                            aobject[i] = this.a(extraCount, jsonarray1.get(i), type, jsondeserializationcontext);
                             if (aobject[i] instanceof ChatComponentText) {
                                 ChatComponentText chatcomponenttext = (ChatComponentText) aobject[i];
 
@@ -117,12 +150,30 @@ public interface IChatBaseComponent extends Iterable<IChatBaseComponent> {
                 if (jsonobject.has("extra")) {
                     JsonArray jsonarray2 = jsonobject.getAsJsonArray("extra");
 
+                    // FlamePaper start - Limit ChatComponents
+                    if (jsonarray2.size() > 12) {
+                        throw new JsonParseException("Too many ChatComponent array elements in extra");
+                    }
+                    // FlamePaper end - Limit Chatcomponents
+
+                    // FlamePaper start - Limit ChatComponents
+                    if (extraCount > 12) {
+                        throw new JsonParseException("Too many stacked extra ChatComponent elements");
+                    }
+                    // FlamePaper end - Limit Chatcomponents
+
                     if (jsonarray2.size() <= 0) {
                         throw new JsonParseException("Unexpected empty array of components");
                     }
 
                     for (int j = 0; j < jsonarray2.size(); ++j) {
-                        ((IChatBaseComponent) object).addSibling(this.a(jsonarray2.get(j), type, jsondeserializationcontext));
+                        // FlamePaper start - Limit ChatComponents
+                        if (jsonarray2.get(j).isJsonArray()) {
+                            throw new JsonParseException("Stacked ChatComponent array in extra element");
+                        }
+                        // FlamePaper end - Limit Chatcomponents
+
+                        ((IChatBaseComponent) object).addSibling(this.a(++extraCount, jsonarray2.get(j), type, jsondeserializationcontext));
                     }
                 }
 
