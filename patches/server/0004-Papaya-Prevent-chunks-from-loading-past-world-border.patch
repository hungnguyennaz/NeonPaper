From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: moo <48740106+moom0o@users.noreply.github.com>
Date: Mon, 28 Jun 2021 18:25:09 -0400
Subject: [PATCH] (Papaya) Prevent chunks from loading past world border

Original code by moom0o, licensed under GPLv3
Yoi can find the original code on https://github.com/moom0o/Papaya

diff --git a/src/main/java/me/hungnguyennaz/neonpaper/NeonPaperConfig.java b/src/main/java/me/hungnguyennaz/neonpaper/NeonPaperConfig.java
index 29e098898efcb426fc7ace2cdb433c7ad1969718..7520fdc06805f51ce945b406778895411174c5b5 100644
--- a/src/main/java/me/hungnguyennaz/neonpaper/NeonPaperConfig.java
+++ b/src/main/java/me/hungnguyennaz/neonpaper/NeonPaperConfig.java
@@ -174,4 +174,9 @@ public class NeonPaperConfig {
         return config.getString(path, config.getString(path));
     }
 
+    public static Boolean preventChunksWorldBorder = true;
+    private static void preventChunksWorldBorder() {
+        preventChunksWorldBorder = getBoolean("settings.prevent-chunks-generating-past-worldborder-lag-exploit", true);
+    }
+
 }
diff --git a/src/main/java/net/minecraft/server/ChunkProviderServer.java b/src/main/java/net/minecraft/server/ChunkProviderServer.java
index ca89369cec5423786e0446858301e4e6f3fe5626..3afc01d06794ebdb25c18dfeb3086e48645dbba2 100644
--- a/src/main/java/net/minecraft/server/ChunkProviderServer.java
+++ b/src/main/java/net/minecraft/server/ChunkProviderServer.java
@@ -4,6 +4,7 @@ import com.destroystokyo.paper.exception.ServerInternalException;
 import it.unimi.dsi.fastutil.longs.Long2ObjectOpenHashMap;
 import it.unimi.dsi.fastutil.longs.LongArraySet;
 import it.unimi.dsi.fastutil.longs.LongIterator;
+import me.hungnguyennaz.neonpaper.NeonPaperConfig;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 import org.bukkit.craftbukkit.chunkio.ChunkIOExecutor;
@@ -104,8 +105,10 @@ public class ChunkProviderServer implements IChunkProvider {
             chunk = this.loadChunk(i, j);
             if (chunk != null) {
                 this.chunks.put(ChunkCoordIntPair.a(i, j), chunk);
-                chunk.addEntities();
-                chunk.loadNearby(this, this.chunkGenerator, false); // CraftBukkit
+                if(!NeonPaperConfig.preventChunksWorldBorder || (chunk.locX <= 1875000 && chunk.locZ <= 1875000 && chunk.locX >= -1875000 && chunk.locZ >= -1875000)){ // Papaya - Patch retarded lag exploit at world border
+                    chunk.loadNearby(this, this.chunkGenerator, true); // CraftBukkit
+                    chunk.addEntities();
+                }
             }
         }
 
@@ -182,8 +185,11 @@ public class ChunkProviderServer implements IChunkProvider {
             }
 
             this.chunks.put(k, chunk);
-            chunk.addEntities();
-            chunk.loadNearby(this, this.chunkGenerator, true); // CraftBukkit
+
+            if(!NeonPaperConfig.preventChunksWorldBorder || (chunk.locX <= 1875000 && chunk.locZ <= 1875000 && chunk.locX >= -1875000 && chunk.locZ >= -1875000)){ // Papaya - Patch retarded lag exploit at world border
+                chunk.loadNearby(this, this.chunkGenerator, true); // CraftBukkit
+                chunk.addEntities();
+            }
             world.timings.syncChunkLoadTimer.stopTiming(); // Spigot
         }
 
diff --git a/src/main/java/net/minecraft/server/PlayerChunk.java b/src/main/java/net/minecraft/server/PlayerChunk.java
index 71906caa0b229217eac7404ccba0453e96624d0f..39dcc3f024371aa894bdfd79058bbd7bde843d26 100644
--- a/src/main/java/net/minecraft/server/PlayerChunk.java
+++ b/src/main/java/net/minecraft/server/PlayerChunk.java
@@ -6,6 +6,7 @@ import com.google.common.collect.Lists;
 import java.util.Iterator;
 import java.util.List;
 import javax.annotation.Nullable;
+import me.hungnguyennaz.neonpaper.NeonPaperConfig;
 import org.apache.logging.log4j.LogManager;
 import org.apache.logging.log4j.Logger;
 // CraftBukkit Start
@@ -48,12 +49,14 @@ public class PlayerChunk {
     public PlayerChunk(PlayerChunkMap playerchunkmap, int i, int j) {
         this.playerChunkMap = playerchunkmap;
         this.location = new ChunkCoordIntPair(i, j);
-        // CraftBukkit start
-        loadInProgress = true;
-        this.chunk = playerchunkmap.getWorld().getChunkProviderServer().getChunkAt(i, j, loadedRunnable, false);
-        this.chunkExists = this.chunk != null || ChunkIOExecutor.hasQueuedChunkLoad(playerChunkMap.getWorld(), i, j); // Paper
-        markChunkUsed(); // Paper - delay chunk unloads
-        // CraftBukkit end
+        if(!NeonPaperConfig.preventChunksWorldBorder || (location.x <= 1875000 && location.z <= 1875000 && location.x >= -1875000 && location.z >= -1875000)) { // Papaya - Patch retarded lag exploit at world border
+            // CraftBukkit start
+            loadInProgress = true;
+            this.chunk = playerchunkmap.getWorld().getChunkProviderServer().getChunkAt(i, j, loadedRunnable, false);
+            this.chunkExists = this.chunk != null || ChunkIOExecutor.hasQueuedChunkLoad(playerChunkMap.getWorld(), i, j); // Paper
+            markChunkUsed(); // Paper - delay chunk unloads
+            // CraftBukkit end
+        }
     }
 
     public ChunkCoordIntPair a() {
diff --git a/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java b/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java
index cdf3b614c78fe2684e586263aa9c1688e146f8d7..77d9f63c0c3d70cd5cccfc30254a48c2f1ff1a1f 100644
--- a/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java
+++ b/src/main/java/org/bukkit/craftbukkit/chunkio/ChunkIOProvider.java
@@ -8,6 +8,7 @@ import net.minecraft.server.ChunkCoordIntPair;
 import net.minecraft.server.ChunkRegionLoader;
 import net.minecraft.server.NBTTagCompound;
 
+import me.hungnguyennaz.neonpaper.NeonPaperConfig;
 import org.bukkit.Server;
 import org.bukkit.craftbukkit.util.AsynchronousExecutor;
 
@@ -56,7 +57,9 @@ class ChunkIOProvider implements AsynchronousExecutor.CallBackProvider<QueuedChu
             queuedChunk.provider.chunkGenerator.recreateStructures(chunk, queuedChunk.x, queuedChunk.z);
         }
 
-        chunk.loadNearby(queuedChunk.provider, queuedChunk.provider.chunkGenerator, false);
+        if(!NeonPaperConfig.preventChunksWorldBorder || (chunk.locX <= 1875000 && chunk.locZ <= 1875000 && chunk.locX >= -1875000 && chunk.locZ >= -1875000)){ // Papaya - Patch retarded lag exploit at world border
+            chunk.loadNearby(queuedChunk.provider, queuedChunk.provider.chunkGenerator, false);
+        }
         } // Paper
     }
 
